---
title: "Acessando APIs com R: GitHub - Parte 1"
date: "2021-11-30"
tags: ["api", "github", "git", "purrr"]
categories: ["pacotes"]
#image: "images/posts/banner/echarts.png"
author: ["Beatriz", "Julio"]
summary: "Segundo post sobre acesso à APIs."
draft: true
---

```{r, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

## Introdução

Esse post faz parte de uma série sobre acesso à APIs com R! Neste post mostraremos um exemplo usando a **API do GitHub**.

O GitHub é ...., e podemos fazer **muitas** coisas utilizando a API. E como dissemos no post anterior: "o primeiro passo para acessar qualquer API é procurar uma documentação". A boa notícia é que a [documentação da API do GitHub](https://docs.github.com/pt/rest) está disponível em Português e é bem detalhada!   


Existem muitas possibilidades de ações a serem feitas utilizando essa API, e o que escolhemos para esse exemplo é buscar os repositórios que pertencem à uma organização. 

Segundo a documentação, para consultar os repositórios que pertencem à organização octokit, podemos utilizar a seguinte busca:

```
GET /orgs/octokit/repos
```
O equivalente à isso usando o pacote `httr` seria:

```{r}
# url_base - nunca muda na mesma API
url_base <- "https://api.github.com"      

# endpoint - é o que muda o resultado
endpoint <- "/orgs/octokit/repos"                 

# precisamos colar os textos para criar o link
u_github <- paste0(url_base, endpoint) 

# ver como o texto ficou colado
# u_github 
# > "https://api.github.com/orgs/octokit/repos"

# fazer a requisição do tipo GET
r_github <- httr::GET(u_github) 

r_github

# httr::content(r_github)
```



## O que é o pacote `gh`?


```{r}
# gh::gh("GET /orgs/{org}/repos", org = "octokit")
```


## Primeiro exemplo com o pacote `gh`

```{r}
gh_curso_r <- gh::gh("GET /orgs/{org}", org = "curso-r")
gh_curso_r
```


```{r}
repositorios_cursor <- gh::gh("GET /orgs/{org}/repos", org = "curso-r")

class(repositorios_cursor)

length(repositorios_cursor)
```


## Iterando com purrr e o pacote `gh`


```{r}
numero_repos_publicos <- gh_curso_r$public_repos

numero_paginas <- ceiling(numero_repos_publicos/100)
```


```{r, cache = TRUE}
library(magrittr)
repos_cursor <- purrr::map(1:numero_paginas, .f = ~gh::gh(
    "GET /orgs/{org}/repos",
    org = "curso-r",
    type = "public",
    sort = "updated",
    per_page = 100,
    page = .x
  ))
```


```{r}
library(magrittr)
  lista_repos <-  repos_cursor %>%
          purrr::flatten() %>%
    purrr::map(unlist, recursive = TRUE) %>%
    purrr::map(tibble::enframe) %>%
    purrr::map(tidyr::pivot_wider,
               names_from = name,
               values_from = value) %>%
    purrr::reduce(dplyr::bind_rows) %>%
    janitor::clean_names()
  
dplyr::glimpse(lista_repos)  
```


```{r}
df_repos_cursor  <- lista_repos %>%
    dplyr::filter(fork == FALSE) %>%
  dplyr::select(name,
                created_at,
                default_branch) %>%
dplyr::mutate(
    data_criacao = readr::parse_datetime(created_at),
    ano_criacao = as.Date(lubridate::floor_date(data_criacao, "year"))
  )
```


## Exemplo de visualização com os dados obtidos!

```{r}
library(ggplot2)
df_repos_cursor %>% 
  dplyr::count(ano_criacao, default_branch, sort = TRUE) %>% 
  ggplot() + 
  geom_col(aes(y = n, x = ano_criacao, fill = default_branch)) + 
  theme_bw() +
  scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
    scale_fill_brewer(palette = "Pastel1")

```


É isso! Dúvidas, sugestões e críticas, mande aqui nos comentários. **Postem também quais exemplos, dentre os que foram listados, vocês gostariam de saber mais!!**

Até a próxima!


## Referências

- [Slides do curso de Deploy](https://curso-r.github.io/main-deploy/docs/index.html#12)

- [Slides do curso de Web Scraping sobre APIs](https://curso-r.github.io/main-web-scraping/slides/02-introducao-ao-ws.html#8)

- Pacote [`httr`](https://cran.r-project.org/web/packages/httr/vignettes/quickstart.html)


