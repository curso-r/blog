---
title: "Como usar senhas sem escreve-las nos scripts"
date: "2022-09-13"
tags: ["Boas práticas"]
categories: ["Tutorial"]
image: "images/posts/conteudo/2022-09-13-senha-no-script/logo-featured.jpg"
author: ["Beatriz Milz"]
summary: "Nesse post, apresentamos formas de usar senhas, tokens e keys no código em R de forma segura."
draft: false
---



<div id="introdução" class="section level2">
<h2>Introdução</h2>
<p>As vezes precisamos usar alguma senha/Token/Key para rodar um código, como por exemplo ao usar uma API que solicita autenticação. Mas isso significa que devemos escrever a senha no próprio script <code>.R</code>, por exemplo?</p>
<p><strong>Não!</strong> Inclusive isso é um pouco perigoso. Imagina armazenar a senha para um serviço pago, esquecer e disponibilizar o script no GitHub? É receita para receber uma notificação do cartão de crédito cobrando algo que nem usamos… É, já ouvi casos assim!</p>
<p>Então neste post trago algumas dicas para evitar salvar as senhas nos scripts quando estiver programando.</p>
</div>
<div id="variáveis-de-ambiente" class="section level2">
<h2>Variáveis de ambiente</h2>
<p>Uma forma de fazer isso é com as variáveis de ambiente (<em>environment variables</em>). Não vou detalhar o conceito de ambientes mas deixei um link nas referências, ao final do post.</p>
<p>Simplificando, as variáveis de ambientes são objetos que são carregados ao iniciar a sessão do R. Então eles ficarão disponíveis para uso, apesar de não aparecer no painel <em>Environment</em> do RStudio.</p>
<p>Uma forma de saber quais são as nossas variáveis de ambiente é usando a função <code>Sys.getenv()</code> sem argumentos. Atenção, várias variáveis de configuração irão aparecer no output e não recomendo alterá-las.</p>
<p>A função <code>Sys.setenv()</code> permite que você salve a senha/token nas variáveis de ambiente. Cuidado, rode essa etapa no console e não salve no script (pois justamente queremos não armazenar as senhas no script, certo?).</p>
<pre class="r"><code>Sys.setenv(MINHA_SENHA = 1234)</code></pre>
<p>Para buscar o valor salvo na variável, pode usar a função <code>Sys.getenv()</code>. Essa função podemos usar no nosso script sem problemas!</p>
<pre class="r"><code>Sys.getenv(&quot;MINHA_SENHA&quot;)
## [1] &quot;1234&quot;</code></pre>
</div>
<div id="indo-além-com-a-ajuda-do-usethis" class="section level2">
<h2>Indo além com a ajuda do usethis</h2>
<p>As variáveis de ambiente podem ser vinculadas ao <code>.Rproj</code> ativo, ou ao usuário do computador. Elas ficam salvas no arquivo <code>.Renviron</code>. Para abrir o arquivo e ver as variáveis de ambiente salvas, você pode usar a função <code>usethis::edit_r_environ()</code>:</p>
<pre class="r"><code># Abre as variáveis de ambiente para o usuário do computador
usethis::edit_r_environ(scope = &quot;user&quot;)
#&gt; • Modify &#39;/Users/beatrizmilz/.Renviron&#39;
#&gt; • Restart R for changes to take effect

# Abre as variáveis de ambiente para o projeto ativo
usethis::edit_r_environ(scope = &quot;project&quot;)
#&gt; ✔ Setting active project to &#39;/Users/beatrizmilz/Documents/GitHub/blog-en&#39;
#&gt; • Modify &#39;.Renviron&#39;
#&gt; • Restart R for changes to take effect</code></pre>
<p>O padrão para armazenar variáveis neste arquivo é:</p>
<pre><code>NOME_VAR=&#39;SENHAAQUI12345&#39;</code></pre>
<p><strong>Atenção!</strong> Depois de alterar o arquivo <code>.Renviron</code>, é necessário reiniciar o R para que as mudanças sejam consideradas. Isso porque esse arquivo é carregado ao iniciar o R.</p>
<p><strong>Atenção 2</strong>: Caso você use um arquivo <code>.Renviron</code> vinculado ao seu projeto <code>.Rproj</code>, cuidado ao subir esse arquivo para o GitHub, é perigoso pois pessoas poderão ver suas senhas. Se o seu repositório for público, é essencial que você adicione ele no <code>.gitignore</code>, assim ele será ignorado pelo Git. A função <code>usethis::use_git_ignore()</code> pode nos ajudar nisso:</p>
<pre class="r"><code>usethis::use_git_ignore(&quot;.Renviron&quot;)
#&gt; ✔ Adding &#39;.Renviron&#39; to &#39;.gitignore&#39;</code></pre>
</div>
<div id="solicitar-a-senha" class="section level2">
<h2>Solicitar a senha</h2>
<p>E quando queremos que a pessoa usuária possa sempre escrever a senha? Existe uma função para isso: <code>rstudioapi::askForPassword()</code>. Podemos inclusive escrever a frase que será mostrada ao perguntar a senha. A senha digitada será retornada como um texto, e podemos salvar em um objeto para utilizar posteriormente no que for necessário.</p>
<pre class="r"><code>senha_informada &lt;- rstudioapi::askForPassword(
  &quot;Escreva sua senha por favor!&quot;
)</code></pre>
<div class="figure">
<img src="/images/posts/conteudo/2022-09-13-senha-no-script/askforpassword.png" fig-align="center" style="width:90.0%" alt="" />
<p class="caption">Pop up feito pela função askForPassword.</p>
</div>
</div>
<div id="github-actions" class="section level2">
<h2>GitHub Actions</h2>
<p>E quando precisamos usar senhas em códigos rodados com GitHub Actions (GHA)? Se você não conhece nada sobre GHA, <a href="series-gha.qmd">eu tenho alguns posts sobre isso</a>!</p>
<p>Quando estamos usando GHA, podemos adicionar senhas na sessão SECRETS do GitHub. Assim ninguém (exceto você, quando cria um SECRETS), verá a senha/credenciais.</p>
<p>Isso fica nas configurações do repositório, e o link usa esse padrão:</p>
<pre><code>https://github.com/SEU-USUARIO/SEU-REPOSITORIO/settings/secrets/actions</code></pre>
<p>Exemplo de um repositório privado meu:</p>
<div class="figure">
<img src="/images/posts/conteudo/2022-09-13-senha-no-script/githubsecrets.png" fig-align="center" style="width:90.0%" alt="" />
<p class="caption">Print screen da página de secrets.</p>
</div>
<p>Também é preciso adaptar o código do action para buscar essa variável no Secrets. Exemplo de código:</p>
<pre><code>      - name: Execute Script
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
          NOME_VAR: ${{ secrets.NOME_VAR }}
        run: |
          Rscript &quot;seu_script.R&quot;</code></pre>
<p>Com isso é possível acessar essas variáveis com senha, no script usando a função <code>Sys.getenv('NOME_VAR')</code> que mostrei acima.</p>
</div>
<div id="mais-camadas-de-segurança" class="section level2">
<h2>Mais camadas de segurança</h2>
<p>Para mais camadas de segurança, recomendo a leitura da <a href="https://httr2.r-lib.org/articles/wrapping-apis.html#secret-management">documentação do pacote httr2, no trecho sobre <em>Secret management</em></a>. Nesse trecho, além de apresentar a opção utilizando a função <code>usethis::edit_r_environ()</code>, também é apresentado as funções <code>httr2::secret_encrypt()</code> e <code>htt2::secret_decrypt()</code>.</p>
<p>Eu ainda não testei essas funções pois o pacote <code>httr2</code> é bem recente. Segundo o autor do pacote (o <a href="https://hadley.nz/">Hadley Wickham</a>), com essas funções é possível usar criptografia para lidar com as senhas/tokens.</p>
</div>
<div id="conclusão" class="section level2">
<h2>Conclusão</h2>
<p>Esperamos que este post seja interessante para você, e que as suas senhas estejam sempre protegidas! Bons estudos e até a próxima!</p>
</div>
<div id="referências" class="section level2">
<h2>Referências</h2>
<ul>
<li><p><a href="https://rstudio-education.github.io/hopr/environments.html#assignment">Environments/Ambientes - Hands-On Programming with R</a></p></li>
<li><p><a href="https://httr2.r-lib.org/articles/wrapping-apis.html#secret-management">Secret management - Documentação do pacote httr2</a></p></li>
</ul>
</div>
<div id="agradecimentos" class="section level2">
<h2>Agradecimentos</h2>
<ul>
<li><p>Julio Trecenti, pela leitura prévia e sugestões feitas no texto.</p></li>
<li><p>Tive a ideia de escrever esse post ao responder uma pergunta feita pela aluna Mari Ribeiro, em um curso da Curso-R. Obrigada Mari!</p></li>
</ul>
</div>
