---
title: "Ordenando strings no R"
date: "2023-03-06"
tags: ["r", "programação"]
categories: ["tutoriais"]
image: "images/posts/banner/ordenando-strings.webp"
author: ["Caio"]
summary: "Nem sempre é simples ordenar strings no R corretamente!"
draft: false
---



<p>Recentemente a <a href="https://twitter.com/beamilz">Beatriz Milz</a> trouxe para o Slack
da Curso-R uma dúvida intrigante:</p>
<blockquote>
<p>[…] Quando ordeno com arrange uma coluna, tem um valor que começa com A que
aparece no final da lista!</p>
</blockquote>
<p>O exemplo dela envolvia ordenar uma coluna de textos de uma tabela. A ordenação
funcionava normalmente com <code>sort()</code>, mas não com <code>arrange()</code>. Veja a
demonstração a seguir:</p>
<pre class="r"><code># Tabela exemplo
df &lt;- tibble::tibble(bebida = c(
  &quot;Cerveja&quot;,
  &quot;Cachaça&quot;,
  &quot;Água&quot;,
  &quot;Vinho&quot;,
  &quot;Gim&quot;
))

# Tudo certo por aqui
sort(df$bebida)
#&gt; [1] &quot;Água&quot;    &quot;Cachaça&quot; &quot;Cerveja&quot; &quot;Gim&quot;     &quot;Vinho&quot;

# Água fica por último!
dplyr::arrange(df, bebida)
#&gt; # A tibble: 5 × 1
#&gt;   bebida
#&gt;   &lt;chr&gt;
#&gt; 1 Cachaça
#&gt; 2 Cerveja
#&gt; 3 Gim
#&gt; 4 Vinho
#&gt; 5 Água</code></pre>
<p>O nosso principal suspeito era o mesmo de qualquer problema com strings:
encoding ou, em bom português,
<a href="https://pt.wikipedia.org/wiki/Codifica%C3%A7%C3%A3o">codificação</a>. Contudo,
desta vez ele não é o culpado; os caracteres do texto estão sendo interpretados
e exibidos corretamente na saída de ambos os comandos, indicando que a causa da
ordenação incorreta era outra.</p>
<p>Em busca de uma resposta, resolvi ler a documentação da função <code>arrange()</code>. Para
a minha surpresa, descobri que ela tem um argumento <code>.locale</code> cujo valor por
padrão é “o locale <code>"C"</code>”… Mas, o que isso significa? Normalmente vemos
problemas de <a href="https://pt.wikipedia.org/wiki/Locale">locale</a> quando lidamos com
tempo, porque essa é a opção que determina o formato de exibição das datas
(<code>DD/MM/AAAA</code> no Brasil, <code>MM/DD/AAAA</code> nos EUA, etc.). Será que ela poderia ter
alguma coisa a ver com a ordenação de textos?</p>
<p>Seguindo as pistas na documentação da <code>arrange()</code>, eventualmente cheguei na
função <code>stringi::stri_opts_collator()</code>, que ajusta as opções do <em>ICU Collator</em>.
E foi aí que tudo fez sentido.</p>
<div id="collation" class="section level2">
<h2>Collation</h2>
<p><a href="https://en.wikipedia.org/wiki/Collation"><em>Collation</em></a> é um termo em inglês que
descreve a compilação e ordenação de qualquer tipo de informação. A
(surpreendente!) realidade é que cada país e idioma tem regras diferentes de
ordenação alfabética, então é necessário escolher qual método de <em>collation</em> o R
vai usar através do locale.</p>
<p>Para ilustrar a função do locale, imagine um problema mais simples: queremos que
o R leia adequadamente uma data em alemão. Obviamente, ele não vai conseguir:</p>
<pre class="r"><code>lubridate::dmy(&quot;6. März 2023&quot;)
#&gt; Warning: All formats failed to parse. No formats found.
#&gt; [1] NA</code></pre>
<p>Para corrigir isso, precisamos especificar o argumento <code>locale</code>, indicando para
o R que o conteúdo está escrito em alemão (<code>"de_DE"</code> para alemão da Alemanha):</p>
<pre class="r"><code>lubridate::dmy(&quot;6. März 2023&quot;, locale = &quot;de_DE&quot;)
#&gt; [1] &quot;2023-03-06&quot;</code></pre>
<p>O chocante é que o mesmo vale para a ordem alfabética. Nós geralmente não
percebemos que tem algo errado com o locale da <em>collation</em> porque as regras de
ordenação são muito parecidas em todos os países, mas existem diferenças sutis
que causam problemas como o da Bea.</p>
<p>O programa que está tomando essas decisões de locale por trás dos panos se chama
<a href="https://github.com/unicode-org/icu">ICU</a>; esta biblioteca do C é a base do
stringi, o motor por trás do stringr e da <code>arrange()</code>. Como você pode imaginar,
o locale padrão da ICU é o da linguagem C de programação, que coloca letras
acentuadas no fim do alfabeto.</p>
<p>Sendo assim, podemos resolver a questão do <code>arrange()</code> especificando o nosso
locale (<code>"pt_BR"</code> para português do Brasil):</p>
<pre class="r"><code>dplyr::arrange(df, bebida, .locale = &quot;pt_BR&quot;)
#&gt; # A tibble: 5 × 1
#&gt;   bebida
#&gt;   &lt;chr&gt;
#&gt; 1 Água
#&gt; 2 Cachaça
#&gt; 3 Cerveja
#&gt; 4 Gim
#&gt; 5 Vinho</code></pre>
<p>É muito interessante ler a
<a href="https://unicode-org.github.io/icu/userguide/collation/">documentação</a> do ICU
sobre <em>collation</em>, pois ela deixa muito claro que é absolutamente impossível
criar um locale que atenda às necessidades de todos os países:</p>
<ul>
<li>Em lituano, o “y” fica entre o “i” e o “k”.</li>
<li>No espanhol tradicional, “ch” é tratado como uma única letra entre o “c” e o
“d”.</li>
<li>Em dinamarquês, “Å” é considerada uma letra separada que fica depois do “Z”.</li>
<li>Na Suécia, “v” e “w” são consideradas variações de uma mesma letra.</li>
<li>Em dicionários alemães, “öf” vem antes de “of”, mas em listas telefônicas a
ordem preferida é a contrária.</li>
</ul>
<p>O bom é que isso também esclarece o porquê da <code>sort()</code> funcionar, mas a
<code>arrange()</code> não. Enquanto a segunda usa o locale <code>"C"</code> por padrão, a primeira
usa o locale americano (<code>"en_US"</code> para inglês dos EUA)! Apesar de o locale
americano nos causar problemas com datas, ele é muito parecido com o brasileiro
na ordem alfabética e essencialmente ignora os acentos durante a <em>collation</em>.</p>
</div>
<div id="resumo" class="section level2">
<h2>Resumo</h2>
<p>A função <code>arrange()</code> pode causar problemas na hora de ordenar textos em
português. Isso ocorre porque o locale de <em>collation</em> padrão coloca todas as
letras acentuadas no final do alfabeto, algo muito pouco usual no nosso idioma.
A solução é especificar o argumento <code>.locale = "pt_BR"</code> para que ela use o
locale apropriado ao nosso alfabeto.</p>
</div>
